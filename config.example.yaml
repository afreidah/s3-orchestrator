# -------------------------------------------------------------------------------
# S3 Orchestrator - Configuration Example
#
# Author: Alex Freidah
#
# Reference configuration with all available options and inline documentation.
# Copy to config.yaml and fill in values. Environment variables use ${VAR_NAME}
# syntax for expansion.
# -------------------------------------------------------------------------------

server:
  # Address to listen on (host:port)
  listen_addr: "0.0.0.0:9000"

  # Maximum upload size in bytes (default: 5 GB)
  # max_object_size: 5368709120

  # TLS configuration. When cert_file and key_file are both set, the server
  # listens with TLS. Omit both for plain HTTP. Certificates are hot-reloaded
  # on SIGHUP without dropping connections.
  # tls:
  #   cert_file: "/etc/s3-orchestrator/tls/cert.pem"
  #   key_file: "/etc/s3-orchestrator/tls/key.pem"
  #   min_version: "1.2"           # "1.2" (default) or "1.3"
  #   client_ca_file: ""           # Path to CA bundle for mTLS client verification

# Virtual buckets with per-bucket credentials. Each bucket gets its own
# namespace via internal key prefixing. Multiple services can share a bucket
# by each having their own credentials.
buckets:
  - name: "app1-files"
    credentials:
      - access_key_id: "${APP1_ACCESS_KEY}"
        secret_access_key: "${APP1_SECRET_KEY}"

  - name: "shared-files"
    credentials:
      # Writer service credentials
      - access_key_id: "${WRITER_ACCESS_KEY}"
        secret_access_key: "${WRITER_SECRET_KEY}"
      # Reader service credentials
      - access_key_id: "${READER_ACCESS_KEY}"
        secret_access_key: "${READER_SECRET_KEY}"

  # Legacy token auth (backward compatibility)
  # - name: "legacy-bucket"
  #   credentials:
  #     - token: "${LEGACY_TOKEN}"

database:
  host: "${DB_HOST}"
  port: 5432
  database: "s3proxy"
  user: "${DB_USER}"
  password: "${DB_PASSWORD}"
  ssl_mode: "require"    # default: require (use "disable" for local dev)
  # max_conns: 10        # Max pool connections (default: 10)
  # min_conns: 5         # Min idle connections (default: 5)
  # max_conn_lifetime: "5m"

# Write routing strategy for new objects.
# "pack" (default) fills backends in config order; "spread" picks the least utilized.
# routing_strategy: "pack"

backends:
  - name: "oci"
    # S3-compatible endpoint URL
    # OCI: https://<namespace>.compat.objectstorage.<region>.oraclecloud.com
    # AWS: https://s3.us-east-1.amazonaws.com
    # B2:  https://s3.us-west-002.backblazeb2.com
    endpoint: "${S3_ENDPOINT}"
    region: "${S3_REGION}"
    bucket: "${S3_BUCKET}"
    access_key_id: "${S3_ACCESS_KEY_ID}"
    secret_access_key: "${S3_SECRET_ACCESS_KEY}"
    force_path_style: true    # required for OCI, MinIO, B2
    # unsigned_payload: true  # stream uploads without buffering (default: true)
    quota_bytes: 21474836480  # 20 GB (0 or omit for unlimited)
    # api_request_limit: 0    # monthly API request limit (0 = unlimited)
    # egress_byte_limit: 0    # monthly egress byte limit (0 = unlimited)
    # ingress_byte_limit: 0   # monthly ingress byte limit (0 = unlimited)

telemetry:
  metrics:
    enabled: true
    path: "/metrics"
  tracing:
    enabled: false
    endpoint: "localhost:4317"
    insecure: true
    sample_rate: 1.0

# Circuit breaker for database outages. Always active with sensible defaults.
# circuit_breaker:
#   failure_threshold: 3   # consecutive failures before opening (default: 3)
#   open_timeout: "15s"    # delay before probing recovery (default: 15s)
#   cache_ttl: "60s"       # keyâ†’backend cache TTL during degraded reads (default: 60s)

# Periodic object rebalancing across backends. Disabled by default.
# rebalance:
#   enabled: false
#   strategy: "pack"       # "pack" (consolidate) or "spread" (equalize)
#   interval: "6h"
#   batch_size: 100
#   threshold: 0.1         # min utilization spread to trigger (0-1)

# Cross-backend object replication. factor=1 means no replication.
# replication:
#   factor: 1              # copies per object (max: number of backends)
#   worker_interval: "5m"
#   batch_size: 50

# Per-IP rate limiting. Disabled by default.
# rate_limit:
#   enabled: false
#   requests_per_sec: 100
#   burst: 200
#   trusted_proxies:          # CIDRs whose X-Forwarded-For is trusted
#     - "10.0.0.0/8"          # Without this, XFF is ignored and RemoteAddr is
#     - "172.16.0.0/12"       # always used. Uses rightmost-untrusted extraction.

# Built-in web dashboard for operational visibility and management. Disabled by default.
# Requires admin_key and admin_secret for login when enabled.
# ui:
#   enabled: false
#   path: "/ui"                          # URL prefix for the dashboard (default: "/ui")
#   admin_key: "${UI_ADMIN_KEY}"         # access key for dashboard login
#   admin_secret: "${UI_ADMIN_SECRET}"   # secret key for dashboard login
