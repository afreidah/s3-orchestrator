<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>S3 Orchestrator</title>
  <link rel="icon" type="image/svg+xml" href="static/favicon.svg">
  <link rel="stylesheet" href="static/style.css?v={{.Version}}">
</head>
<body>
<div class="container">

  <!-- Header -->
  <header>
    <div>
      <h1>S3 Orchestrator</h1>
      <span class="meta">{{.Version}}</span>
    </div>
    <div class="header-right">
      {{if .DBHealthy}}
        <span class="badge badge-healthy">Healthy</span>
      {{else}}
        <span class="badge badge-degraded">Degraded</span>
      {{end}}
      <a href="logout" class="logout-link">Logout</a>
    </div>
  </header>

  <!-- Storage Summary -->
  <section>
    <h2>Storage Summary</h2>
    <div class="config-grid">
      <div class="config-card">
        <div class="label">Total Used</div>
        <div class="value">{{formatBytes .TotalBytesUsed}}</div>
      </div>
      <div class="config-card">
        <div class="label">Total Capacity</div>
        <div class="value">
          {{- if eq .TotalBytesLimit 0}}unlimited
          {{- else}}{{formatBytes .TotalBytesLimit}}
          {{- end -}}
        </div>
      </div>
      <div class="config-card">
        <div class="label">Usage</div>
        <div class="value">{{pct .TotalBytesUsed .TotalBytesLimit}}</div>
      </div>
    </div>
    {{if ne .TotalBytesLimit 0}}
    <div class="bar-track" style="margin-top:0.5rem">
      <div class="bar-fill" style="width:{{pctFloat .TotalBytesUsed .TotalBytesLimit}}%;background:{{barColor .TotalBytesUsed .TotalBytesLimit}}"></div>
    </div>
    {{end}}
  </section>

  <!-- Backends -->
  <section>
    <h2>Backends
      <button id="rebalance-btn" class="btn-action">Rebalance</button>
      <button id="sync-btn" class="btn-action">Sync</button>
    </h2>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th class="num">Quota Used</th>
          <th class="num">Quota Limit</th>
          <th class="num">Usage</th>
          <th style="width:20%"></th>
          <th class="num">Objects</th>
          <th class="num">Multipart</th>
        </tr>
      </thead>
      <tbody>
        {{range .Data.BackendOrder}}
          {{$stat := index $.Data.QuotaStats .}}
          {{$objects := index $.Data.ObjectCounts .}}
          {{$multipart := index $.Data.ActiveMultipartCounts .}}
          <tr>
            <td>{{.}}</td>
            <td class="num">{{formatBytes $stat.BytesUsed}}</td>
            <td class="num">
              {{- if eq $stat.BytesLimit 0}}unlimited
              {{- else}}{{formatBytes $stat.BytesLimit}}
              {{- end -}}
            </td>
            <td class="num">{{pct $stat.BytesUsed $stat.BytesLimit}}</td>
            <td>
              {{if ne $stat.BytesLimit 0}}
              <div class="bar-track">
                <div class="bar-fill" style="width:{{pctFloat $stat.BytesUsed $stat.BytesLimit}}%;background:{{barColor $stat.BytesUsed $stat.BytesLimit}}"></div>
              </div>
              {{end}}
            </td>
            <td class="num">{{formatNumber $objects}}</td>
            <td class="num">{{formatNumber $multipart}}</td>
          </tr>
        {{end}}
      </tbody>
    </table>
  </section>

  <!-- Monthly Usage -->
  <section>
    <h2>Monthly Usage ({{.Data.UsagePeriod}})</h2>
    <table>
      <thead>
        <tr>
          <th>Backend</th>
          <th class="num">API Requests</th>
          <th class="num">API Limit</th>
          <th class="num">Egress</th>
          <th class="num">Egress Limit</th>
          <th class="num">Ingress</th>
          <th class="num">Ingress Limit</th>
        </tr>
      </thead>
      <tbody>
        {{range .Data.BackendOrder}}
          {{$usage := index $.Data.UsageStats .}}
          {{$limits := index $.Data.UsageLimits .}}
          <tr>
            <td>{{.}}</td>
            <td class="num">{{formatNumber $usage.APIRequests}}</td>
            <td class="num">
              {{- if eq $limits.APIRequestLimit 0}}unlimited
              {{- else}}{{formatNumber $limits.APIRequestLimit}}
              {{- end -}}
            </td>
            <td class="num">{{formatBytes $usage.EgressBytes}}</td>
            <td class="num">
              {{- if eq $limits.EgressByteLimit 0}}unlimited
              {{- else}}{{formatBytes $limits.EgressByteLimit}}
              {{- end -}}
            </td>
            <td class="num">{{formatBytes $usage.IngressBytes}}</td>
            <td class="num">
              {{- if eq $limits.IngressByteLimit 0}}unlimited
              {{- else}}{{formatBytes $limits.IngressByteLimit}}
              {{- end -}}
            </td>
          </tr>
        {{end}}
      </tbody>
    </table>
  </section>

  <!-- Objects -->
  <section>
    <h2>Objects</h2>
    <div class="upload-bar">
      <button id="upload-btn" class="btn-upload">Upload</button>
      <span id="upload-status"></span>
    </div>
    <input type="file" id="upload-file" hidden>
    {{if .Data.TopLevelEntries.Entries}}
    <div class="object-tree" id="object-tree">
      {{range .Data.TopLevelEntries.Entries}}
        {{if .IsDir}}
        <details class="tree-dir" data-prefix="{{.Name}}" data-loaded="false">
          <summary>
            <span class="tree-name">{{.Name}}</span>
            <span class="tree-meta">{{.FileCount}} files &middot; {{formatBytes .TotalSize}}</span>
          </summary>
          <div class="tree-children">
            <div class="tree-loading">Loading&hellip;</div>
          </div>
        </details>
        {{else}}
        <div class="tree-file" data-key="{{.Name}}">
          <span class="tree-name">{{.Name}}</span>
          <span class="tree-meta">{{.Backend}} &middot; {{formatBytes .TotalSize}} &middot; {{.CreatedAt}}</span>
          <span class="tree-action tree-delete" title="Delete">&#x2715;</span>
        </div>
        {{end}}
      {{end}}
    </div>
    {{else}}
    <p class="empty">No objects stored.</p>
    {{end}}
  </section>

  <!-- Configuration -->
  <section>
    <h2>Configuration</h2>
    <div class="config-grid">
      <div class="config-card">
        <div class="label">Virtual Buckets</div>
        <div class="value">{{range $i, $b := .Buckets}}{{if $i}}, {{end}}{{$b}}{{end}}</div>
      </div>
      <div class="config-card">
        <div class="label">Write Routing</div>
        <div class="value">{{.Config.RoutingStrategy}}</div>
      </div>
      <div class="config-card">
        <div class="label">Replication Factor</div>
        <div class="value">{{.Config.ReplicationFactor}}</div>
      </div>
      <div class="config-card">
        <div class="label">Rebalancer</div>
        <div class="value">
          {{if .Config.RebalanceEnabled}}enabled ({{.Config.RebalanceStrategy}})
          {{else}}disabled
          {{end}}
        </div>
      </div>
      <div class="config-card">
        <div class="label">Rate Limiting</div>
        <div class="value">
          {{if .Config.RateLimitEnabled}}enabled
          {{else}}disabled
          {{end}}
        </div>
      </div>
    </div>
  </section>

</div>

<dialog id="confirm-delete">
  <p>Delete <strong id="confirm-delete-name"></strong>?</p>
  <div class="dialog-actions">
    <button id="confirm-delete-cancel">Cancel</button>
    <button id="confirm-delete-ok" class="btn-danger">Delete</button>
  </div>
</dialog>

<dialog id="upload-dialog">
  <p>Upload to:</p>
  <input type="text" id="upload-key" required>
  <div class="dialog-actions">
    <button id="upload-cancel">Cancel</button>
    <button id="upload-ok">Upload</button>
  </div>
</dialog>

<dialog id="sync-dialog">
  <p>Sync backend objects into a virtual bucket:</p>
  <label class="sync-label" for="sync-backend">Backend</label>
  <select id="sync-backend">
    {{range .Data.BackendOrder}}<option value="{{.}}">{{.}}</option>{{end}}
  </select>
  <label class="sync-label" for="sync-bucket">Bucket</label>
  <select id="sync-bucket">
    {{range .Buckets}}<option value="{{.}}">{{.}}</option>{{end}}
  </select>
  <div class="dialog-actions">
    <button id="sync-cancel">Cancel</button>
    <button id="sync-ok">Sync</button>
  </div>
</dialog>

<script>
  window.__buckets = [{{range $i, $b := .Buckets}}{{if $i}},{{end}}"{{$b}}"{{end}}];
</script>
<script src="static/tree.js?v={{.Version}}"></script>
</body>
</html>
